---
title: "Flexibility of interactions depends on habitat suitability"
author: 
  - "E. Fernando Cagua^1^ ([efc29@uclive.ac.nz](mailto:efc29@uclive.ac.nz))"
  - "Audrey Lustig^2^ ([audrey.lustig@canterbury.ac.nz](audrey.lustig@canterbury.ac.nz))"
  - "Jason M. Tylianakis^1^ ([jason.tylianakis@canterbury.ac.nz](jason.tylianakis@canterbury.ac.nz))"
  - "Daniel B. Stouffer^1^ ([daniel.stouffer@canterbury.ac.nz](daniel.stouffer@canterbury.ac.nz))"
bibliography: 
  - bibliography.bib
  - int-bibliography.bib
csl: pnas.csl
output: #word_document
  bookdown::pdf_document2:
    # base_format: rticles::peerj_article
    keep_tex: yes
    number_sections: false
toc: false
fontsize: 11pt
# classoption: a4paper
geometry: 
  - textwidth=33em
  - textheight=48\baselineskip
header-includes:
  - \usepackage{booktabs}
  - \usepackage{setspace}
  - \usepackage{lineno}
  - \usepackage{xr}
  - \usepackage[utf8]{inputenc}
  - \newcommand{\R}[1]{\label{#1}\linelabel{#1}}
  - \newcommand{\lr}[1]{page~\pageref{#1}, line~\lineref{#1}}
  - \externaldocument{supp-info}
  - \usepackage[export]{adjustbox}
editor_options: 
  chunk_output_type: console
---

\linenumbers
\doublespacing

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE, dpi = 300, 
                      eval.after = "fig.cap")

library(dplyr)

loadd(abs_wordcount, msc_wordcount, n_displays, n_references, keywords)
loadd(interaction_citations)
```
 
^1^ Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

^2^ Geospatial Research Institute, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

**Running title:** XX

**Keywords:** `r keywords`

**Type of article:** XX

**Number of words:** `r abs_wordcount$n_words_stri` in abstract; `r format(round(msc_wordcount$n_words_stri), big.mark = ",")` in main text.

**Number of displays:** `r n_displays$figures` figures; `r n_displays$tables` tables; `r n_displays$text_boxes` text boxes.

**Number of references:** `r n_references + nrow(interaction_citations)`

**Author for correspondence:** E. Fernando Cagua (+64 20 4026 8153).

**Data accessibility:** Data supporting the results will be accessible in an appropriate data repository after publication. The DOI will be included here.

**Author contributions:** XX

\clearpage

# Abstract

`r paste(drake::readd(abstract), collapse = "")`

\clearpage

# Introduction

# Methods

## Data aquisition

### Species interactions

```{r}
loadd(config)
loadd(int_metadata)

n_published_studies <- int_metadata$reference %>%
  unique() %>%
  stringr::str_detect(pattern = "unpubl", negate = TRUE) %>%
  sum()

all_int_cites <- paste0("@", interaction_citations$BIBTEXKEY) %>%
  glue::glue_collapse(sep = "; ") %>%
  paste0("[", ., "]")

int_citations_year_range <- range(interaction_citations$YEAR)
```

```{r scientific-names-cleaning-info}
loadd(checked_sp_names, spp, manual_name_corrections, problematic_networks)

n_sp_names <- n_distinct(spp$sp_name) 

n_sp_names_subsp_level <- filter(spp, is_subspecies) %$%
  n_distinct(sp_name)

n_sp_names_sp_level <- filter(spp, !sp_unidentified, !subspecies) %$% 
  n_distinct(sp_name)

n_sp_names_gen_level <- filter(spp, sp_unidentified, !gen_unidentified) %$% 
  n_distinct(sp_name)

n_no_tax_info <- filter(spp, gen_unidentified) %$% n_distinct(sp_name) 

n_sp_correct_in_data <- checked_sp_names %>%
  filter(good_queried_sp_name) %$%
  n_distinct(queried_sp_name)

n_sp_corrected_typos <- checked_sp_names %>%
  filter(corrected_typo) %$% 
  n_distinct(queried_sp_name)

sp_with_synonyms <- checked_sp_names %>%
  filter(alt_sp_name_found) 

n_sp_with_synonyms <- sp_with_synonyms %$%
  n_distinct(queried_sp_name)

sp_not_found <- checked_sp_names %>%
  filter(!good_queried_sp_name) %>% 
  filter(!alt_sp_name_found, !corrected_typo) 

n_sp_not_found <- sp_not_found %$%
  n_distinct(queried_sp_name)

n_sp_manual_corrections <- manual_name_corrections %>%
  filter(!is.na(sp_name)) %$%
  n_distinct(queried_sp_name)

study_per_location <- int_metadata %>%
  distinct(loc_id, reference)

n_names_in_multiple_references_orig <- spp %>%
  left_join(study_per_location, by = "loc_id") %>%
  group_by(sp_name) %>%
  summarise(n_net = n_distinct(loc_id), 
            n_ref = n_distinct(reference)) %>%
  filter(n_ref > 1) %$%
  n_distinct(sp_name)
```

We retrieved plant-pollinator networks from the Web of Life database [@fortuna_web_2014]. 
This database contains datasets originating from `r length(interaction_citations$BIBTEXKEY)` studies published in the primary literature between `r int_citations_year_range[1]` and `r int_citations_year_range[2]` `r all_int_cites`.
All together, these data sources contained `r format(n_sp_names, big.mark = ",")` unique organism names; `r format(n_names_in_multiple_references_orig, big.mark = ",")` of them in more than one data source.
Because assessing how habitat suitability affects interaction partners of plants and pollinators requires linking of species across different datasets, it was important to ensure that the names used to identify species were as accurate as possible.
From the total number of organisms,`r format(n_sp_names_subsp_level, big.mark = ",")` were identified to the subspecies or variety level, `r format(n_sp_names_sp_level, big.mark = ",")`  to the species level, `r format(n_sp_names_gen_level, big.mark = ",")` to the genus level, and no taxonomic information was avaliable for the remaining `r format(n_no_tax_info, big.mark = ",")`. 
As the species level was the most common taxonomic level available in our interaction datasets, for all further analysis, we consider only the species of organisms that were identified to the subspecies or variety level.

We were able to confirm the validity of `r format(n_sp_correct_in_data, big.mark = ",")` of the cannonical names used to identify organisms to the species level (roughly `r scales::percent(n_sp_correct_in_data/n_sp_names_sp_level, 1)`). 
We assessed the validity of a scientific name by querying the Global Names Resolver database (https://resolver.globalnames.org) which includes taxonomic data from `r dplyr::n_distinct(taxize::gnr_datasources()$title)` taxonomic sources. 
Specifically, we used the function `gnr_resolve` from the R package `taxize` `r as.character(packageVersion('taxize'))` [@chamberlain_taxize_2013; @chamberlain_taxize_2019].

From the remaining `r format(n_sp_names_sp_level - n_sp_correct_in_data, big.mark = ",")` names we were unable to validate, we were able to identify and correct `r format(n_sp_corrected_typos, big.mark = ",")` spelling mistakes. 
These spelling mistakes were corrected automatically by fuzzy matching the canonical names in our data sources with tgose in the Global Names Resover database. 
In rare occasions, the fuzzy matching algorithm can suggest a cannonical name that has similar spelling but that correspond to an organism in a completely different taxonomic group, often in a different kingdom. 
We, therefore, checked the taxonomic hierarchy of suggested names to confirm that it corresponded to our expectations. 
We retrieved all taxonomic hierarchies from the National Center for Biotechnology Information taxonomic database (https://www.ncbi.nlm.nih.gov/taxonomy). 

Subsequently, we checked for possible synonyms of the canonnical names in our data sources. 
Using data from the Integrated Taxonomic Information System database (http://www.itis.gov), we found synonyms and alternative names for `r format(n_sp_with_synonyms, big.mark = ",")` of those in our data sources.
Finding these alternative names was important due to two reasons. 
First, because we wanted to be able to identify the cases in which the same organism might have been recorded with different cannonical names in different data sources. This can ocurr not only with synonyms but also when the cannonical name has been changed or when there are widely used ortographic variants.
Second, because retrieving occurrence data is often only possible using the latest accepted/valid name for a particular species.

All together, from the `r format(n_sp_names_sp_level - n_sp_correct_in_data, big.mark = ",")` names we were unable to validate, it was not possible to automatically correct `r format(n_sp_not_found, big.mark = ",")` of them. 
We then manually consulted multiple online databases, chiefly Wikispecies (https://species.wikimedia.org/), and looked for cannonical names that resembled the unvalidated names and matched the geographic and taxonomic spectations. 
We were able to further correct `r n_sp_manual_corrections` names in this fashion.
Most manual corrections were of species names that have been abbreviated or had more than two spelling mistakes. 
A complete list of manual name corrections can bee seen in Table \@ref(tab:tab-manual-name-corrections).

```{r}
loadd(recoded_interactions, clean_interactions)

n_sp_ids <- recoded_interactions %>%
  select(-loc_id) %>%
  purrr::map(n_distinct) %>%
  unlist() %>% sum()

n_names_in_multiple_references_after <- recoded_interactions %>%
  tidyr::gather(key = "guild", "sp_id", pla_id, ani_id) %>%
  left_join(study_per_location, by = "loc_id") %>%
  group_by(sp_id) %>%
  summarise(n_ref = n_distinct(reference)) %>%
  filter(n_ref > 1) %$%
  n_distinct(sp_id)

stats_clean_int <- clean_interactions %>%
  purrr::map(n_distinct)
```

This cleaning process allowed us to match further `r n_sp_names - n_sp_ids` names across data sources and, by doing so, identify another `r n_names_in_multiple_references_after - n_names_in_multiple_references_orig` species that were present in more than one study. 
It also allowed us to identify `r numbers2words(length(problematic_networks))` problematic networks in which some names were included as both plants and pollinators. 
These networks were removed from further analysis. 
Sometimes interaction data was recorded at multiple points in time within or across our data sources. 
When this was the case, we combined them into one single interaction network per location. 
The cleaning process resulted on a total of `r format(stats_clean_int$pla_id, big.mark = ",")` plants and `r format(stats_clean_int$ani_id, big.mark = ",")` pollinator species distributed across `r format(stats_clean_int$loc_id)` locations arround the globe (Figure \@ref(fig:fig-worldmap), \@ref(fig:fig-distribution-species-mult-locations)).

```{r fig-worldmap, fig.width = width('single'), fig.cap ="Worldwide distribution of pollination communities included in this study"}
readd(fig_worldmap)
```

```{r fig-distribution-species-mult-locations, fig.width = width('single'), fig.height = 2.2, fig.cap = fig_dist_species_multiple_locations_legend}

most_popular_species <- readd(fig_dist_species_multiple_locations_data) %>%
  filter(n_locations == max(n_locations)) %>%
  arrange(guild) 

fig_dist_species_multiple_locations_legend <- 
  paste0("Frequency distribution of the number of locations in which a species is present. The most common pollinator species was *", 
       most_popular_species$sp_name[1], 
       "*, which was sampled on ", 
       most_popular_species$n_locations[1], 
       " locations, while the most common plant species was *", 
       most_popular_species$sp_name[2], 
       "*, which was sampled on ", 
       most_popular_species$n_locations[2], 
       " locations.")

readd(fig_dist_species_multiple_locations)
```

### Species suitability

```{r}
loadd(spp_to_download, gbif_keys, n_occurrences, n_cleaned_occurrences)
n_species_with_occurrences <- dplyr::full_join(spp_to_download, gbif_keys, 
		 by = c("sp_name" = "queried_sp_name")) %>%
  dplyr::inner_join(n_occurrences, by = c("key" = "taxonKey")) %$% 
  dplyr::n_distinct(sp_id)

n_species_with_cleaned_occurrences <-  dplyr::full_join(spp_to_download, gbif_keys, 
		 by = c("sp_name" = "queried_sp_name")) %>%
  dplyr::inner_join(n_cleaned_occurrences, by = c("key" = "taxonKey")) %$% 
  dplyr::n_distinct(sp_id)

```

Our next step was to determine the habitat suitability of the species that were present in at least `r numbers2words(readd(minimum_spp_locations))` communities.
When organims were identified to the subspecies or varieties, we , 
To do that we first fit a climatic envelope for each  of them which requires information about the climate and their known occurrences. 
We retrieved occurrences from the Global Biodiversity Information Facility (https://www.gbif.org) using the R package `rgbif` `r as.character(packageVersion('taxize'))` [@chamberlain_r_2017; @chamberlain_rgbif_2019].
We only requested occurrences that had geolocation information and no known geospatial issue.
This resulted into roughly `r round(sum(n_occurrences$N)/1000000, digits = 1)` million occurrences for `r format(n_species_with_occurrences, big.mark = ",")` species.
We were unable to find occurrences for the remaining `r dplyr::n_distinct(spp_to_download$sp_id) - n_species_with_occurrences` species. 
We then filtered these occurrence and kept only those with higher quality information. 
Specifically, we removed occurrences with a coordinate uncertainity larger than 100km and those recorded prior to 1945 (Audrey: ref? or why?).
We also removed occurrences in which the number of individuals recorded was zero or more than 100 as such large counts are often erroneous (Audrey: ref? or why?). 
We only kept occurrence records describing a human observation and preserved specimens as they are more reliable (Audrey: ref?why?). 
After these filtering, we used the R package `CoordinateCleaner` `r as.character(packageVersion('taxize'))` [@zizka_coordinatecleaner_2019] to further identify (*i*) coordinates outside the borders of the country in which they were recorde, (*ii*) those arround a the country capital or the centroid of the country and province centroids, (*iii*) those arond a biodiversity institution, and (*iv*) those located within oceans. 
We used land and country data from Natural Earth (https://www.naturalearthdata.com) with a 1:10,000,000 scale. 
This resulted in `r round(sum(n_cleaned_occurrences$N)/1000000, digits = 1)` million occurrences for `r n_species_with_cleaned_occurrences` species. 

We then tried to retrieve occurrences for  species that were present in at least  communities in our dataset. 
To do that we 
First we downloaded climatic data from WorldClim V2.0 which includes 19 bioclimatic variables commonly used in species distribution modelling [@fick_worldclim_2017]. 
These bioclimatic variables were complemented with 16 of bioclimatic and topographic variables available in ENVIREM [@title_envirem_2018]. 
This additional set of variables have been shown to be relevant to ecological or physiological processes and as such have the potential to improve species distribition models.
All climatic data was obtained with a 2.5 arc-minuteresolution which provides a reasonable match to the locational accuracy of the species occurrences found in GBIF, particularly those that come from museum collections. 
Furthermore, we obtained habitat data from the 
 

See topography data from Species distribution model transferability and model grain size – finer may not always be better

# Results

# Discussion 

# Acknowledgements

`r paste(drake::readd(acknowledgements), collapse = "")`

# References

