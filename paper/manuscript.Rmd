---
title: "Flexibility of interactions depends on habitat suitability"
author: 
  - "E. Fernando Cagua^1^ ([efc29@uclive.ac.nz](mailto:efc29@uclive.ac.nz))"
  - "Audrey Lustig^2^ ([audrey.lustig@canterbury.ac.nz](audrey.lustig@canterbury.ac.nz))"
  - "Jason M. Tylianakis^1^ ([jason.tylianakis@canterbury.ac.nz](jason.tylianakis@canterbury.ac.nz))"
  - "Daniel B. Stouffer^1^ ([daniel.stouffer@canterbury.ac.nz](daniel.stouffer@canterbury.ac.nz))"
bibliography: 
  - bibliography.bib
  - int-bibliography.bib
csl: pnas.csl
output: #word_document
  bookdown::pdf_document2:
    # base_format: rticles::peerj_article
    keep_tex: yes
    number_sections: false
toc: false
fontsize: 11pt
# classoption: a4paper
geometry: 
  - textwidth=33em
  - textheight=48\baselineskip
header-includes:
  - \usepackage{booktabs}
  - \usepackage{setspace}
  - \usepackage{lineno}
  - \usepackage{xr}
  - \usepackage[utf8]{inputenc}
  - \newcommand{\R}[1]{\label{#1}\linelabel{#1}}
  - \newcommand{\lr}[1]{page~\pageref{#1}, line~\lineref{#1}}
  - \externaldocument[S-]{supp-info}
  - \usepackage[export]{adjustbox}
editor_options: 
  chunk_output_type: console
---

\linenumbers
\doublespacing

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE, dpi = 300, 
                      eval.after = "fig.cap")

library(dplyr)

loadd(abs_wordcount, msc_wordcount, n_displays, n_references, keywords)
loadd(interaction_citations)
```
 
^1^ Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

^2^ Geospatial Research Institute, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

**Running title:** XX

**Keywords:** `r keywords`

**Type of article:** XX

**Number of words:** `r abs_wordcount$n_words_stri` in abstract; `r format(round(msc_wordcount$n_words_stri), big.mark = ",")` in main text.

**Number of displays:** `r n_displays$figures` figures; `r n_displays$tables` tables; `r n_displays$text_boxes` text boxes.

**Number of references:** `r n_references + nrow(interaction_citations)`

**Author for correspondence:** E. Fernando Cagua (+64 20 4026 8153).

**Data accessibility:** Data supporting the results will be accessible in an appropriate data repository after publication. The DOI will be included here.

**Author contributions:** XX

\clearpage

# Abstract

`r paste(drake::readd(abstract), collapse = "")`

\clearpage

# Introduction

# Methods

```{r}
loadd(config)
loadd(int_metadata)

n_published_studies <- int_metadata$reference %>%
  unique() %>%
  stringr::str_detect(pattern = "unpubl", negate = TRUE) %>%
  sum()

```

We retrieved plant-pollinator networks from the Web of Life database [@fortuna_web_2014] on `r format(as.Date(config$raw_data_retrieved), "%B %Y")` (Figure \@ref(fig:fig-worldmap)). 
This database contains datasets originating from XX studies published in the primary literature between XX and XX. 
Before assessing how habitat suitability affects interaction partners of plants and pollinators we need to link species across different datasets. 
However, this task is complicated by the inacurracies often found in diverse data sources. 
Most commonly, there are typos in the species names, species names have bee abbreviated or a single species might be recorded as different synonyms in different sources. 
To alleviate this issue we restored to the following procedure. 

```{r scientific-names-cleaning-info}
loadd(checked_sp_names, spp)

checked_sp_names <- checked_sp_names %>%
  # remove variant and subspecies abbreviations from the retrieved species
  # names, it is clear that they are one when there is 3 words or more in there
  mutate(sp_name = stringr::str_replace_all(sp_name,"var. ", ""),
         sp_name = stringr::str_replace_all(sp_name,"ssp. ", ""),
         sp_name_in_gnr = !is.na(gnr_score), 
         sp_name_itis_invalid = itis %in% c("invalid", "not accepted"), 
         # good species name has been found and its not invalid
         good_sp_name = sp_name_in_gnr & ! sp_name_itis_invalid, 
         good_queried_sp_name = good_sp_name & sp_name == queried_sp_name, 
         sp_name_rank = get_name_rank(sp_name), 
         queried_sp_name_rank = get_name_rank(queried_sp_name)) %>%
  group_by(queried_sp_name) %>%
  mutate(corrected_typo = any(gnr_score == 0.750) & all(sp_name_rank == queried_sp_name_rank),
         corrected_typo = tidyr::replace_na(corrected_typo, FALSE),
         good_queried_sp_name = any(good_queried_sp_name), 
         n_spellings = n_distinct(sp_name), 
         any_sp_itis_invalid = any(sp_name_itis_invalid), 
         alt_sp_name_found = n_spellings > 1 & any_sp_itis_invalid) %>%
  ungroup()

spp %>%
  distinct(sp_name, guild, loc_id) %>%
  group_by(sp_name) %>%
  mutate(n_guilds = n_distinct(guild)) %>% 
  inner_join(checked_sp_names, by = c("sp_name" = "queried_sp_name")) %>% 
  filter(n_guilds > 1) %>% View
  n_distinct(sp_name)

n_sp_names <- n_distinct(spp$sp_name)

n_sp_names_sp_level <- filter(spp, !sp_unidentified) %$% 
  n_distinct(sp_name)

n_sp_names_gen_level <- filter(spp, sp_unidentified, !gen_unidentified) %$% 
  n_distinct(sp_name)

n_no_tax_info <- filter(spp, gen_unidentified) %$% n_distinct(sp_name) 

n_sp_correct_in_data <- checked_sp_names %>%
  filter(good_queried_sp_name) %$%
  n_distinct(queried_sp_name)

n_sp_corrected_typos <- checked_sp_names %>%
  filter(corrected_typo) %$% 
  n_distinct(queried_sp_name)

sp_with_synonyms <- checked_sp_names %>%
  filter(alt_sp_name_found) 

n_sp_with_synonyms <- sp_with_synonyms %$%
  n_distinct(queried_sp_name)

n_sp_not_found <- checked_sp_names %>%
  filter(!good_queried_sp_name) %>% 
  filter(!alt_sp_name_found, !corrected_typo) %$%
  n_distinct(queried_sp_name)


checked_sp_names %>%
  filter(!good_queried_sp_name, !alt_sp_name_found) %$% n_distinct(queried_sp_name)
```

First, we used data from the Integrated Taxonomic Information System database (http://www.itis.gov) on `r format(as.Date(config$raw_data_retrieved), "%B %Y")` to find synonyms of species names recorded in the datasets. 
Subsequently, we checked the spelling of species names using the Global Names Resolver (https://resolver.globalnames.org) which includes taxonomic data from `r dplyr::n_distinct(taxize::gnr_datasources()$title)` taxonomic sources. 
Using the function `gnr_resolve` in the R package `taxize` [@chamberlain_taxize_2013; @chamberlain_taxize_2019] and used fuzzy matching of the canonical names to obtain the most likely correct spelling of incorrect scientific names. 
As, ocassionally, homonimus species or genus names can be found in different taxa, we retrieved higher taxonomic hierarchy to confirm that the correct spelling obtained using the Global Names Resolver matches our expectations. 
This hierarchy was retrieved from the National Center for Biotechnology Information taxonomic database (https://www.ncbi.nlm.nih.gov/taxonomy). 

All together, before correcting typos and synonyms, the data sources contained `r format(n_sp_names, big.mark = ",")` unique interacting species. 
From that total, `r format(n_sp_names_sp_level, big.mark = ",")` were originally identified to the species-level, `r format(n_sp_names_gen_level, big.mark = ",")` to the genus level, and no taxonomic information was avaliable for the remaining `r format(n_no_tax_info, big.mark = ",")` organims. 
We were able to confirm the validity of `r format(n_sp_correct_in_data, big.mark = ",")` of the scientific names used to identify organisms to the species level (roughly `r scales::percent(n_sp_correct_in_data/n_sp_names_sp_level, 1)`). 
We assessed the validity of a scientific name by querying the Global Names Resolver database (https://resolver.globalnames.org) which includes taxonomic data from `r dplyr::n_distinct(taxize::gnr_datasources()$title)` taxonomic sources. 
Specifically, we used the function `gnr_resolve` from the R package `taxize `r as.character(packageVersion('taxize'))`` [@chamberlain_taxize_2013; @chamberlain_taxize_2019].

From the remaining `r format(n_sp_names_sp_level - n_sp_correct_in_data, big.mark = ",")` scientific names we were unable to validate, we were able to identify and the correct `r format(n_sp_corrected_typos, big.mark = ",")` spelling mistakes. 
These mistakes were corrected automatically used by fuzzy matching with the canonical names in the Global Names Resover database. 
Furthermore we found alternative names for `r format(n_sp_with_synonyms, big.mark = ",")` species. 
Most commonly, due to the name being an invalid or not accepted synonym of a species, subspecies, or plant variety (\@ref(tab:tab-sp-synonym-reasons)). 
We were unable to automatically correct `r format(n_sp_not_found, big.mark = ",")` names in the databases. 

```{r tab-sp-synonym-reasons}
sp_with_synonyms %>%
  filter(!is.na(itis_reason)) %>%
  group_by(queried_sp_name) %>%
  summarise(itis_reason = first(itis_reason)) %>%
  group_by(itis_reason) %>%
  count(sort = T) %>%
  knitr::kable(col.names = c("reason of species alternative name", "n"), 
               caption = "tablesita", 
               booktabs = TRUE) %>%
  kableExtra::kable_styling(font_size = 8) 
```

Some studies included interaction data recorded at multiple points in time. 
When this was the case, we combined them into one single interaction network per location. 
All together, these networks included 

```{r fig-worldmap, fig.width = width('single'), fig.cap = paste("Worldwide distribution of pollination communities included in this study. We compile data from", length(interaction_citations$BIBTEXKEY), "published studies", all_int_cites, "which contain interaction information between plant and their pollinators at", dplyr::n_distinct(int_metadata$loc_id), "distinct locations.")}
readd(fig_worldmap)

all_int_cites <- paste0("@", interaction_citations$BIBTEXKEY) %>%
  glue::glue_collapse(sep = "; ") %>%
  paste0("[", ., "]")

```

Climatic data: 
These data are for use in research projects only. A 'research project' is any project carried out by an individual or organized by a university, a scientific institute, or similar organization (private or public) for non-commercial research purposes only. Results based on these data must be submitted for publication in the open literature without any delay linked to commercial objectives. An additional restriction is that the UK Met. Office/Hadley Centre requires strict adherence to the conditions set forth in their "License Statement", which applies to their model output: "These data are licensed for use in Research Projects only. A 'Research Project' is any project organised by a university, a scientific institute, or similar organisation (private or public), for non-commercial research purposes only. A necessary condition of the recognition of non-commercial purposes is that all the results obtained are openly available at delivery costs only, without any delay linked to commercial objectives, and that the research itself is submitted for open publication.

Proper citation and acknowledgement
In first making reference to the data obtained from the CliMond archive, please include the phrase "the CliMond dataset (Kriticos et al. 2012)". Subsequent references within the same publication might refer to the data with terms such as " CliMond data", "the CliMond multi-model dataset", "the CliMond archive", or the " CliMond dataset". Please note the following critical references:

CliMond:
Kriticos DJ, Webber BL, Leriche A, Ota N, Bathols J, Macadam I, Scott JK (2012) CliMond: global high resolution historical and future scenario climate surfaces for bioclimatic modelling. Methods in Ecology and Evolution, 3, 53-64. 
WorldClim:
Hijmans RJ, Cameron SE, Parra JL, Jones PG, Jarvis A (2005) Very high resolution interpolated climate surfaces for global land areas. International Journal of Climatology, 25, 1965-1978. 
CRU:
Mitchell TD, Carter TR, Jones PD, Hulme M, New M (2004) A comprehensive set of climate scenarios for Europe and the globe: the observed record (1900-2000) and 16 scenarios (2000-2100).University of East Anglia, Norwich,UK, pp. 30. 
CMIP3:
Meehl, G. A., C. Covey, T. Delworth, M. Latif, B. McAvaney, J. F. B. Mitchell, R. J. Stouffer, and K. E. Taylor (2007) The WCRP CMIP3 multi-model dataset: A new era in climate change research, Bulletin of the American Meteorological Society, 88, 1383-1394. 
CSIRO Mk 3.0:
Collier MA, Dix MR, Hirst AC (2007) CSIRO Mk3 climate system model and meeting the strict IPCC AR4 data requirements. MODSIM07 International Congress on Modelling and Simulation : Land, water & environmental management : integrated systems for sustainability, 10-13 December [2007] : proceedings (eds Oxley L, Kulasiri D), Christchurch, pp. 582-588. Modelling and Simulation Society of Australia and New Zealand. 
Miroc-H:
Hasumi H, Emori S (2004) K-1 coupled model (MIROC) description, K-1 technical report, 1. Center for Climate System Research, University of Tokyo, Tokyo, 34 pp.


See topography data from Species distribution model transferability and model grain size – finer may not always be better

# Results

# Discussion 

# Acknowledgements

`r paste(drake::readd(acknowledgements), collapse = "")`

# References
