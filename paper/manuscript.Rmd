---
title: "Flexibility of interactions depends on habitat suitability"
author: 
  - "E. Fernando Cagua^1^ ([efc29@uclive.ac.nz](mailto:efc29@uclive.ac.nz))"
  - "Audrey Lustig^2^ ([audrey.lustig@canterbury.ac.nz](audrey.lustig@canterbury.ac.nz))"
  - "Jason M. Tylianakis^1^ ([jason.tylianakis@canterbury.ac.nz](jason.tylianakis@canterbury.ac.nz))"
  - "Daniel B. Stouffer^1^ ([daniel.stouffer@canterbury.ac.nz](daniel.stouffer@canterbury.ac.nz))"
bibliography: 
  - bibliography.bib
  - int-bibliography.bib
csl: pnas.csl
output: #word_document
  bookdown::pdf_document2:
    # base_format: rticles::peerj_article
    keep_tex: yes
    number_sections: false
toc: false
fontsize: 11pt
# classoption: a4paper
geometry: 
  - textwidth=33em
  - textheight=48\baselineskip
header-includes:
  - \usepackage{booktabs}
  - \usepackage{setspace}
  - \usepackage{lineno}
  - \usepackage{xr}
  - \usepackage[utf8]{inputenc}
  - \newcommand{\R}[1]{\label{#1}\linelabel{#1}}
  - \newcommand{\lr}[1]{page~\pageref{#1}, line~\lineref{#1}}
  - \externaldocument{supp-info}
  - \usepackage[export]{adjustbox}
editor_options: 
  chunk_output_type: console
---

\linenumbers
\doublespacing

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE, dpi = 300, 
                      eval.after = "fig.cap")

library(dplyr)

loadd(abs_wordcount, msc_wordcount, n_displays, n_references, keywords, bibliography)
loadd(interaction_citations)
```
 
^1^ Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

^2^ Geospatial Research Institute, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

**Running title:** XX

**Keywords:** `r keywords`

**Type of article:** XX

**Number of words:** `r abs_wordcount$n_words_stri` in abstract; `r format(round(msc_wordcount$n_words_stri), big.mark = ",")` in main text.

**Number of displays:** `r n_displays$figures` figures; `r n_displays$tables` tables; `r n_displays$text_boxes` text boxes.

**Number of references:** `r n_references + nrow(interaction_citations)`

**Author for correspondence:** E. Fernando Cagua (+64 20 4026 8153).

**Data accessibility:** Data supporting the results will be accessible in an appropriate data repository after publication. The DOI will be included here.

**Author contributions:** XX

\clearpage

# Abstract

`r paste(drake::readd(abstract), collapse = "")`

\clearpage

# Introduction

Interactions are selected by species depending on the relative benefit they provide. The assumption goes that species with a large number of interactions are benefit relatively little from each of them, and species with a small number benefit largely with them, this is they focus in more optimal pollinators.

AND 

We know that interactions are influenced by the environment. 

BUT

We don't know how exactly wether the enviroment influences the patterns of generalisation/specialization. 

One option is that when species are in detrimental environmental conditions focus on most optimal partners and as such interact with a smaller number of species. 
An alternative hypotheisis is that when species are in favourable environmental conditions they can afford to be more picky about their interactions and as such avoid those of less value, while individuals in unfavourable conditions must get rewards from whatever they can get. 

THEREFORE

We used a global dataset on plant pollinator interactions, species occurrence, and bioclimatic data to test these hypotheses. 
If the first option is true we should see a negative relationship between environmental sutability and the relative degree of a species. 
If the second option is true we should see the opposite, a positive relationship between environmental suitability and the relative degree of a species. 

# Methods

## Data aquisition

### Species interactions

```{r}
loadd(config)
loadd(int_metadata)

n_published_studies <- int_metadata$reference %>%
  unique() %>%
  stringr::str_detect(pattern = "unpubl", negate = TRUE) %>%
  sum()

all_int_cites <- paste0("@", interaction_citations$BIBTEXKEY) %>%
  glue::glue_collapse(sep = "; ") %>%
  paste0("[", ., "]")

int_citations_year_range <- range(interaction_citations$YEAR)
```

```{r scientific-names-cleaning-info}
loadd(checked_sp_names, spp, manual_name_corrections, problematic_networks)

n_sp_names <- n_distinct(spp$sp_name) 

n_sp_names_subsp_level <- filter(spp, is_subspecies) %$%
  n_distinct(sp_name)

n_sp_names_sp_level_no_subsp <- filter(spp, !sp_unidentified, !is_subspecies) %$% 
  n_distinct(sp_name)

n_sp_names_sp_level <- filter(spp, !sp_unidentified) %$% 
  n_distinct(sp_name)

n_sp_names_gen_level <- filter(spp, sp_unidentified, !gen_unidentified) %$% 
  n_distinct(sp_name)

n_no_tax_info <- filter(spp, gen_unidentified) %$% n_distinct(sp_name) 

n_sp_correct_in_data <- checked_sp_names %>%
  filter(good_queried_sp_name) %$%
  n_distinct(queried_sp_name)

n_sp_corrected_typos <- checked_sp_names %>%
  filter(corrected_typo) %$% 
  n_distinct(queried_sp_name)

sp_with_synonyms <- checked_sp_names %>%
  filter(alt_sp_name_found) 

n_sp_with_synonyms <- sp_with_synonyms %$%
  n_distinct(queried_sp_name)

sp_not_found <- checked_sp_names %>%
  filter(!good_queried_sp_name) %>% 
  filter(!alt_sp_name_found, !corrected_typo) 

n_sp_not_found <- sp_not_found %$%
  n_distinct(queried_sp_name)

n_sp_manual_corrections <- manual_name_corrections %>%
  filter(!is.na(sp_name)) %$%
  n_distinct(queried_sp_name)

study_per_location <- int_metadata %>%
  distinct(loc_id, reference)

n_names_in_multiple_references_orig <- spp %>%
  left_join(study_per_location, by = "loc_id") %>%
  group_by(sp_name) %>%
  summarise(n_net = n_distinct(loc_id), 
            n_ref = n_distinct(reference)) %>%
  filter(n_ref > 1) %$%
  n_distinct(sp_name)
```

We retrieved plant-pollinator networks from the Web of Life database [@fortuna_web_2014]. 
This database contains datasets originating from `r length(interaction_citations$BIBTEXKEY)` studies published in the primary literature between `r int_citations_year_range[1]` and `r int_citations_year_range[2]` `r all_int_cites`.
All together, these data sources contained `r format(n_sp_names, big.mark = ",")` unique organism names; `r format(n_names_in_multiple_references_orig, big.mark = ",")` of them in more than one data source.
Because assessing how habitat suitability affects interaction partners of plants and pollinators requires linking of species across different datasets, it was important to ensure that the names used to identify species were as accurate as possible.
From the total number of organisms,`r format(n_sp_names_subsp_level, big.mark = ",")` were identified to the subspecies or variety level, `r format(n_sp_names_sp_level_no_subsp, big.mark = ",")` to the species level, `r format(n_sp_names_gen_level, big.mark = ",")` to the genus level, and no taxonomic information was avaliable for the remaining `r format(n_no_tax_info, big.mark = ",")`. 
As the species level was the most common taxonomic rank available in our interaction datasets, in all further analysis, we group together subspecies or varieties within a same species. 

We were able to confirm the validity of `r format(n_sp_correct_in_data, big.mark = ",")` of the cannonical names used to identify organisms (roughly `r scales::percent(n_sp_correct_in_data/n_sp_names_sp_level, 1)`). 
We assessed the validity of a cannonical name by querying the Global Names Resolver database (https://resolver.globalnames.org) which includes data from `r dplyr::n_distinct(taxize::gnr_datasources()$title)` taxonomic sources. 
Specifically, we used the function `gnr_resolve` from the R package `taxize` `r as.character(packageVersion('taxize'))` [@chamberlain_taxize_2013; @chamberlain_taxize_2019].

From the remaining `r format(n_sp_names_sp_level - n_sp_correct_in_data, big.mark = ",")` names we were unable to validate, we were able to identify and correct `r format(n_sp_corrected_typos, big.mark = ",")` spelling mistakes. 
These spelling mistakes were corrected automatically by fuzzy matching the canonical names in our data sources with tgose in the Global Names Resover database. 
In rare occasions, the fuzzy matching algorithm can suggest a cannonical name that has similar spelling but that correspond to an organism in a completely different taxonomic group, often in a different kingdom. 
We, therefore, checked the taxonomic hierarchy of suggested names to confirm that it corresponded to our expectations. 
We retrieved all taxonomic hierarchies from the National Center for Biotechnology Information taxonomic database (https://www.ncbi.nlm.nih.gov/taxonomy). 

Subsequently, we checked for possible synonyms of the canonnical names in our data sources. 
Using data from the Integrated Taxonomic Information System database (http://www.itis.gov), we found synonyms and alternative names for `r format(n_sp_with_synonyms, big.mark = ",")` of those in our data sources.
Finding these alternative names was important due to two reasons. 
First, because we wanted to be able to identify the cases in which the same organism might have been recorded with different cannonical names in different data sources. This can ocurr not only with synonyms but also when the cannonical name has been changed or when there are widely used ortographic variants.
Second, because retrieving occurrence data is often only possible using the latest accepted/valid name for a particular species.

All together, from the `r format(n_sp_names_sp_level - n_sp_correct_in_data, big.mark = ",")` names we were unable to validate, it was not possible to automatically correct `r format(n_sp_not_found, big.mark = ",")` of them. 
We then manually consulted multiple online databases, chiefly Wikispecies (https://species.wikimedia.org/), and looked for cannonical names that resembled the unvalidated names and matched the geographic and taxonomic spectations. 
We were able to further correct `r n_sp_manual_corrections` names in this fashion.
Most manual corrections were of species names that have been abbreviated or had more than two spelling mistakes. 
A complete list of manual name corrections can bee seen in Table \@ref(tab:tab-manual-name-corrections).

```{r}
loadd(recoded_interactions, clean_interactions)

n_sp_ids <- recoded_interactions %>%
  select(-loc_id) %>%
  purrr::map(n_distinct) %>%
  unlist() %>% sum()

n_names_in_multiple_references_after <- recoded_interactions %>%
  tidyr::gather(key = "guild", "sp_id", pla_id, ani_id) %>%
  left_join(study_per_location, by = "loc_id") %>%
  group_by(sp_id) %>%
  summarise(n_ref = n_distinct(reference)) %>%
  filter(n_ref > 1) %$%
  n_distinct(sp_id)

stats_clean_int <- clean_interactions %>%
  purrr::map(n_distinct)
```

This cleaning process allowed us to match further `r n_sp_names - n_sp_ids` names across data sources and, by doing so, identify another `r n_names_in_multiple_references_after - n_names_in_multiple_references_orig` species that were present in more than one study. 
It also allowed us to identify `r numbers2words(length(problematic_networks))` problematic networks in which some names were included as both plants and pollinators. 
These networks were removed from further analysis. 
Sometimes interaction data was recorded at multiple points in time within or across our data sources. 
When this was the case, we combined them into one single interaction network per location. 
The cleaning process resulted on a total of `r format(stats_clean_int$pla_id, big.mark = ",")` plants and `r format(stats_clean_int$ani_id, big.mark = ",")` pollinator species distributed across `r format(stats_clean_int$loc_id)` locations arround the globe (Figure \@ref(fig:fig-worldmap), \@ref(fig:fig-distribution-species-mult-locations)).

```{r fig-worldmap, fig.width = width('single'), fig.cap ="Worldwide distribution of pollination communities included in this study"}
readd(fig_worldmap)
```

```{r fig-distribution-species-mult-locations, fig.width = width('single'), fig.height = 2.2, fig.cap = fig_dist_species_multiple_locations_legend}

most_popular_species <- readd(fig_dist_species_multiple_locations_data) %>%
  filter(n_locations == max(n_locations)) %>%
  arrange(guild) 

fig_dist_species_multiple_locations_legend <- 
  paste0("Frequency distribution of the number of locations in which a species is present. The most common pollinator species was *", 
       most_popular_species$sp_name[1], 
       "*, which was sampled on ", 
       most_popular_species$n_locations[1], 
       " locations, while the most common plant species was *", 
       most_popular_species$sp_name[2], 
       "*, which was sampled on ", 
       most_popular_species$n_locations[2], 
       " locations.")

readd(fig_dist_species_multiple_locations)
```

### Species suitability

```{r}
loadd(n_occurrences, n_cleaned_occurrences, n_dirty_occurrences, gbif_key_groups, org_ids, n_thinned_occurrences, complete_climate_cells, complete_filled_cells_1, complete_filled_cells_2)

get_n_species <- . %>%
  dplyr::inner_join(gbif_key_groups, by = "taxonKey") %>%
  dplyr::inner_join(org_ids, by = c("key_id" = "sp_key_id")) %$%
  dplyr::n_distinct(org_id)

n_species_with_occurrences <- get_n_species(n_occurrences)
n_species_with_cleaned_occurrences <- get_n_species(n_cleaned_occurrences) 
n_species_with_dirty_occurrences <- get_n_species(n_dirty_occurrences)
percent_thinned <- 1 - sum(n_thinned_occurrences$N) / sum(n_cleaned_occurrences$N)
percent_filled_round_one <- 1-complete_filled_cells_1[1]/complete_climate_cells[1]
```

Our next step was to determine the suitability of the species that were present in at least `r numbers2words(readd(minimum_spp_locations))` communities.
To do that we first fit a climatic envelope for each  of them which requires information about the climate and habitat at the locations where the species occurrs. 
We retrieved climatic data from WorldClim V2.0 which includes 19 bioclimatic variables commonly used in species distribution modelling [@fick_worldclim_2017]. 
These bioclimatic variables were complemented with 18 of bioclimatic and topographic variables available in Envirem [@title_envirem_2018]. 
This additional set of variables have been shown to be relevant to ecological or physiological processes and as such have the potential to improve species distribition models.
All climatic data was obtained as rasters composed by cells of 2.5 arc-minutes. 
This resolution provides a reasonable match to the locational accuracy of the species occurrences found in GBIF, particularly those that come preserved specimens in museum collections. 
Furthermore, we obtained habitat data from The Nature Conservation's terrestrial ecoregions of the world [@olson_global_2002].

We retrieved occurrences from the Global Biodiversity Information Facility (GBIF; https://www.gbif.org) using the R package `rgbif` `r as.character(packageVersion('taxize'))` [@chamberlain_r_2017; @chamberlain_rgbif_2019].
For each species, we downloaded occurrences for which the coordinates of the observation were available and that had no known geospatial issue in the GBIF database.
Roughly, we downloaded `r round(sum(n_occurrences$N)/1000000, digits = 1)` million occurrences for `r format(n_species_with_occurrences, big.mark = ",")` of the species of interest. 
The occurrences obtained contain observations of mixed quality, so we applied a series of simple filters to remove those of lower quality. 
\R{rationale-occurrence-filtering}Specifically, we removed all occurrences with (*i*) a coordinate uncertainity larger than 100km; (*ii*) those recorded prior to 1945 (ref? or why?); (*iii*) those in which the number of individuals recorded was either zero or more than 100 as such large counts are often erroneous (ref? or why?); and (*iv*) those occurrences in which the "basis of record" was not a human observation or a preserved specimen (ref? why?). 
We then used the R package `CoordinateCleaner` `r as.character(packageVersion('taxize'))` [@zizka_coordinatecleaner_2019] and land mass and country data from Natural Earth (https://www.naturalearthdata.com) with a 1:10,000,000 scale to further identify and remove problematic occurrences. 
We removed occurrences in which their coordinates (*v*) fell outside the borders of the country in which they were recorded; (*vi*) those arround a the country capital or the centroid of the country and province centroids; (*vii*) those arond a biodiversity institution; and (*viii*) those located within oceans. 
Thorugh this cleaning process, we removed with `r round(sum(n_dirty_occurrences$N)/1000000, digits = 1)` million occurrences distributed accross `r n_species_with_dirty_occurrences` species. 
We added the occurrences from our plant-pollinator networks to the cleaned occurrences retrieved from GBIF.

Next, we overlapped the occurrence and our environmental rasters such that each occurrence location is characterized by a vector with information of our 37 bioclimatic and topographic variables . 
If a species had more than one occurrence records within one of the cells of the bioclimatic raster we only included one of the occurrence records. 
We did this to avoid giving more weight to areas with a high number of occurrences, a common scenario in occurrrence records collected opportunistically as the ones we use here. 
Overall we removed `r scales::percent(percent_thinned)` of the occurrences which resulted in a total of `r round(sum(n_thinned_occurrences$N)/1000000, digits = 1)` million occurrences used in our niche analysis. 
A common issue of terrestrial bioclimatic datasets is that the boundaries of the cells with information do not exactly match the land mass boundaries. 
The result of this missmatch is that at least one of the environmental variables was not available for `r format(complete_climate_cells[1], big.mark = ",")` of the raster cells with occurrences (`r scales::percent(complete_climate_cells[1]/sum(complete_climate_cells), accuracy = 0.1)` of the total). 
As expected a vast majority of these cells were close to the shore. 
To address this issue, calculated average value of environmental variables within a `r config$climate_buffer/1000`km buffer of the center of the cell where the variable is missing, and used it to approximate the value of the variable in that cell. 
In this fashion we were able to fill environmental variables for `r scales::percent(percent_filled_round_one, accuracy = 0.1)` of the cells were they were missing. 
To fill the remaining `r format(complete_filled_cells_1[1], big.mark= ",")` cells, we repeated the aforementioned procedure but using a `r config$climate_buffer*2/1000`km buffer. 
We removed from further analyis occurrences located within the `r complete_filled_cells_2[1]` cells for which we were unable to fill environmental variables. 

Our main objective is to investigate wether the suitability of the environment was to obtain the suitability of the environment at the locations for which we have community data. 
This involves two steps. 
First, we determine the species' grinellian niche, the range of environmental conditions that are suitable for a positive growth rate. 
We assume that the suitability of a particular set of environmental conditions (a point in the environmental space) can be inferred from the density of occurrences under these conditions. 
This is, areas of the niche that have a higher density of occurrences have higher suitability and can be interpreted as the core of the species distribution in environental space. 
Contrastingly, areas with a lower density are comparatively less suitable and represent the fringes of the species distribution. 
The second step is to determine the location of our plant-pollinator communities (where the species is present) in the environmental space and calculate its corresponding environmental suitability.

To determine the environmental space we use the first two components from a principal component analysis of the 37 bioclimatic variables associated with the species occurrences. 
Specifically we use the `dudi.pca` function from the R package `ade4` `r as.character(packageVersion('ade4'))` [@dray_ade4_2007] and center and scale all bioclimatic variables to have a mean of 0 and a unit standard deviation. 
We then determine the position of species occurrences in the environmental space and estimate their bivariate density distribution using the kernel method. 
The main advantage of using the kernel method is that it reduces the sensitivity of the niche to sampling effort and the resolution chosen for the environmental space grid [@broennimann_measuring_2012]. 
To calculate the kernel we use `ecospat.grid.clim.dyn` from the R package `ecospat` `r as.character(packageVersion('ecospat'))` [@ecospat_citation] with a grid resolution of 200.
We then normalise the occurrence density distribution such that our suitability ranges beetween 1 for the grids with environmental conditions in which the species was most commonly observed and 0 for the grids in which it was never observed.  
We then determine the location in environmental space of the plant-pollinator communities where the species is present using the function `suprow` from `ade4` and calculate its corresponding suitability using the R package `raster` `r as.character(packageVersion('raster'))` [@raster_citation]. 

```{r sensitivity-analysis-calculations}
loadd(sensitivity_species_name)
loadd(n_enough_occurrences)
n_occ_sensitivity_species <- n_thinned_occurrences %>%
  dplyr::filter(org_id == sensitivity_species_name$org_id[1]) %$% N

n_spp_not_enough_occ <- nrow(n_thinned_occurrences) - nrow(n_enough_occurrences)
```

We used a sensitivity analysis to determine the minimum number of occurrences that are necessary to have robust environmental suitability values in our communities. 
For that we used the species with most occurrences available, *`r sensitivity_species_name$canonicalName`*, and calculated the mean absolute error of the suitability values obtained with `r numbers2words(config$n_subsamples)` subsamples from the `r format(n_occ_sensitivity_species, big.mark  =",")`  occurrences available from GBIF. 
We found that, when we calculate the environmental space independently for each sepecies, we need roughly `r readd(min_occurrences_factor)` independent occurrences for each community for which we calculated a suitability value in order to obtain a mean absolute error below `r config$min_suitability_error` (Fig. \@ref(fig:fig-sensitivity-analysis)). 
We therefore removed from further analyses `r n_spp_not_enough_occ` species for which we did not have enough occurrences to obtain robust estimates.

```{r fig-sensitivity-analysis, fig.width = width('single'), fig.height = 2.2, fig.cap = fig_sensitivity_analysis_legend}

fig_sensitivity_analysis_legend <- 
  paste0("Sensitivity analysis of environmental suitability error. ",
         "The number of independent occurrences retrieved from GBIF is inversely related to the error of environmental suitability for our plant-pollinator networks.", 
         "The error was smaller when environmental space, where species ocurrences are projected, is calculated independently for each species. ", 
         "The sensitivity analysis was performed by subsampling occurrences of", 
         " *", sensitivity_species_name$canonicalName, "* ", 
         "the species in our dataset with the largest number of occurrences in GBIF, which was recorded in two of our communities.")

readd(fig_sensitivity_analysis)
```

## Model

We then investigated 

See topography data from Species distribution model transferability and model grain size â€“ finer may not always be better

# Results

# Discussion 

# Acknowledgements

`r paste(drake::readd(acknowledgements), collapse = "")`

# References

